# スポットインスタンス対応の概要

本システムでは、ゲームサーバーに対してスポットインスタンス運用を行うために以下の仕組みを導入しています。

## 1. サーバー単位のスポット運用フラグ
- `GameServer` エンティティにスポット運用可否を示すカラムを追加しています。
- 管理画面のサーバー編集フォームにチェックボックスを追加し、運用方針を設定できるようにしています。
- 一覧画面で各サーバーのスポット運用可否が確認でき、無効な場合はエラーメッセージを表示します。

## 2. システム全体のスポット運用設定
- システム設定にスポット運用の有効/無効を保持するキーを追加しています。
- 管理画面の設定フォームで有効化フラグを切り替え可能です。
- スポット運用が指定されたサーバーの起動・停止時に、このグローバル設定が有効であるかを検証し、無効の場合はエラーとして扱います。

## 3. 初期データとバリデーション
- データ初期化時にスポット運用関連の設定値をデフォルト登録しています。
- サーバー操作時にはサーバー側のフラグとシステム設定の両方を確認することで、意図しないスポットインスタンス利用を防ぎます。

以上の構成により、既存機能を保持しつつスポットインスタンス運用の可否をデータベースと管理画面設定から判断する仕組みを提供しています。

## 4. スポットインスタンス運用に必要なAWSサービスと設定サンプル
本システムでゲームサーバーをスポットインスタンスで運用する場合、最低限以下のAWSリソースを準備する想定です。実際の環境に合わせてCIDRやインスタンスタイプを調整してください。

### ネットワークと基本設定
- VPC：プライベートサブネットを含む任意のVPC。例）`10.0.0.0/16`。
- サブネット：ゲームサーバーを配置するプライベートサブネット。例）`10.0.1.0/24`。
- セキュリティグループ：ゲームサーバーポート（例：`25565/tcp` など）と管理用SSH（必要なら `22/tcp`）を許可。
- キーペア：初回セットアップやトラブルシュート用にEC2へ接続するキーペアを作成。

### 起動テンプレート（Launch Template）設定例
- インスタンスタイプ：`c6i.large` など 1 つだけ指定（起動テンプレートは単一タイプしか保持できないため）。複数候補は後述の ASG 側で Overrides として追加する。
- AMI：ゲームサーバー実行環境を含むAMIを指定。
- ネットワーク設定：上記プライベートサブネットとセキュリティグループを関連付け。
- IAMロール：ゲームサーバーのログ出力やS3読み取りなど必要な権限を付与。
- その他：ユーザーデータで起動時のセットアップ（Java/ゲームサーバーバイナリ取得など）を実行。

### スポットキャパシティ設定（Auto Scaling またはSpotリクエスト）
- 起動テンプレートを使ったAuto Scaling Group（混合インスタンスポリシー）を作成し、`InstanceDistribution`でスポット比率を高く設定（例：`OnDemandPercentageAboveBaseCapacity=0`）。
- **インスタンスのオーバーライド**に、管理画面の System Settings で登録した「オートスケーリング用インスタンスタイプ」リストをコピーして複数候補を登録する。LT が単一タイプでも ASG 側で複数を持たせることで確保性を高められる。
- サブネットは複数AZに跨らせ、`AllocationStrategy=capacity-optimized` を指定し中断リスクを低減。
- 希望する最大価格を必要に応じて指定（未指定の場合はオンデマンド価格上限）。
- インスタンスリフレッシュやライフサイクルフックを活用し、インスタンス中断時に新規スポットを自動補充。

### 監視・通知
- CloudWatch メトリクスでCPU・メモリ（エージェント導入時）を監視し、スケールアウト/インのポリシーを設計。
- Spot Instance interruption notice（2分前通知）を受け取るために、
  - インスタンス内でメタデータ（`http://169.254.169.254/latest/meta-data/spot/instance-action`）を監視し、
  - 必要に応じてゲームサーバーのセッション切断通知やセーブ処理を行うスクリプトを準備。
- SNS や Slack 連携で中断通知をチームに送信。

### 本システムとの連携ポイント
- 管理画面でサーバーに「スポット運用」を指定した場合でも、上記のようにAWS側でスポット用のLaunch Template/ASGが構成済みであることが前提です。
- グローバル設定（システム設定）でスポット運用を無効化していると、起動/停止操作はエラーになります。
- System Settings に追加された「オートスケーリング用インスタンスタイプ」欄で複数候補を登録でき、ASG Overrides との整合をとりやすくしています。
- 運用チームはこのMDを参考にAWS側の準備を整えた上で、ゲームサーバーの「スポット運用」フラグとシステム設定をONにすることでスポットインスタンス運用を開始できます。
